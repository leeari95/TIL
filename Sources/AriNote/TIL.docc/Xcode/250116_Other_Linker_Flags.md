# 250116 Other Linker Flags

플래그에 -ObjC를 추가해주니 런타임 에러가 해결되었다. 이유가 뭘까?

1월 16일 (목)

# 학습내용

- Xcode에서 타겟 빌드 설정에서 OTHER_LDFLAGS를 -ObjC로 설정해주면 런타임 에러가 해결되는데, 이유가 궁금하다.
- 역할이 뭘까?

# 고민한 점 / 해결방법

## 문제 상황

*  RxSwift, RxCocoa 등 Rx 관련 라이브러리를 Wrapping(포장)한 모듈을 동적 라이브러리로 새롭게 생성하였다.
*  새롭게 생성한 동적 라이브러리를 다른 모듈에서 의존하게 되니까 아래와 같은 런타임 에러가 발생했다.

```
objc[99158]: Class _TtC7RxCocoa25RxScrollViewDelegateProxy is implemented in both (0x103081d60) and (0x105054388). One of the two will be used. Which one is undefined.
```

아래 이슈를 살펴보다가, Tuist 내부적으로 RxSwift를 동적으로 설정하도록 하드코딩 되어있다는 사실을 알게되었다.

> [https://github.com/tuist/tuist/issues/6740#issue-2532702030](https://github.com/tuist/tuist/issues/6740#issue-2532702030)

이슈를 살펴보면 Tuist에서 RxSwift 의존성을 가져올때 RxSwift를 기본적으로 dynamic으로 설정하는 기능이 하드코딩 되어있고, 이 기능이 더이상 필요하지 않다고 검토후 제거해달라는 내용인 것 같다.
결론적으로 위 에러는 정적/동적 혼합 사용으로 인해 발생하는 것으로 추측된다.

테스트해보았을 때, 수동으로 RxSwift를 정적으로 설정해주거나 혹은 RxCocoa 관련된 아이들을 동적으로 설정해주어서 동적/정적을 일관되게 설정해주면 에러가 발생하지 않았다.
또는, OTHER_LDFLAGS를 -ObjC로 설정해주어도 해결되었다. 왜 해결되는지 궁금해서 찾아보았다.

## 정적 라이브러리의 동작

* 정적 라이브러리는 미리 컴파일된 코드 묶음이다. 빌드 시 이 코드가 링크되어 최종 바이너리에 포함된다.
* 하지만 정적 라이브러리는 사용되지 않는 코드들을 제거하는 "최적화" 과정을 거치게 된다. 이 과정에서 앱에서 직접 참조하지 않는  Objective-C 클래스, 카테고리 등이 누락될 수 있다.

## Objective-C의 특성

* Objective-C에서는 런타임 동적 호출이 많이 사용된다.
* 예를 들어, 특정 클래스나 메서드가 명시적으로 호출되지 않더라도 Selector나 Category를 통해 동적으로 사용된다.
* 따라서 정적 라이브러리 내부의 클래스나 카테고리가 앱에서 직접 참조되지 않으므로 최적화 과정에서 삭제될 수 있다.

## -ObjC 플래그의 역할

쉽게 비유하자면 -ObjC는 '집안에 있는 모든 문서를 찾아 정리하라'고 명령하는 것과 비슷하다.

기본적으로는 내가 손에 들고 있는 문서만 정리하지만, -ObjC 플래그를 사용하면 숨겨진 문서까지 모두 챙기도록 강제하는 것이다.
이렇게 하면 누락 없이 모든 문서를 활용할 수 있다.

그래서 정적 라이브러리에서 런타임에 호출될 수 있는 Objective-C 요소를 확실히 포함시키려면 이 플래그를 사용하는게 중요하다.

* -ObjC 플래그는 Objective-C 메타데이터를 모두 포함하도록 강제한다.
* 즉, 링크 시 정적 라이브러리 내의 모든 Objective-C 클래스와 카테고리를 포함하게 하여 런타임에서 누락 문제를 방지한다.
* 특히 Category는 직접적으로 참조되지 않는 경우가 많으므로, 이 플래그가 없으면 정상적으로 동작하지 않을 수 있다.


## -ObjC 플래그는 언제 필요할까?

* 프로젝트에 Objective-C로 작성된 정적 라이브러리를 포함하고, 해당 라이브러리가 카테고리나 런타임 동적 호출을 사용하는 경우에 필요하다.


# 정리

나에게 선택지는 총 3가지가 있었다.
1. Tuist의 Package.swift 내에서 RxSwift를 정적으로 수동 설정 해준다.
2. 혹은 RxCocoa, RxCocoaRuntime.. 등 RxCocoa 관련 라이브러리들을 동적으로 수동 설정 해준다.
3. 패키지 설정을 아무것도 하지 않고, 타겟 빌드 설정 내에서 OTHER_LDFLAGS를 -ObjC로 설정해준다.

아주 간단한 방법인 3번째 방법으로 위 에러를 해결하게 되었다. 일단 1, 2번은 Tuist 내부 구조가 수정될 가능성이 있어보였고, 추후 RxSwift를 동적으로 맵핑해주는 하드코딩된 로직이 사라지게 된다고 한다면, -ObjC 플래그를 설정해주는 방법이 적절해보였다.

* -ObjC 플래그가 없는 경우는, 앱을 짓는 동안 “필요한 도구만 챙겨라”는 명령을 받고 작업하는 것과 비슷하다.
  * 이 과정에서 “어디에 쓰일지 몰라서 직접 참조하지 않은 도구”들은 다 버려진다.
* 그런데 작업 중에 갑자기 “숨겨진 도구”가 필요해지면, 이미 버렸기 때문에 문제가 생겨버린다.
* -ObjC는 “필요할 수도 있는 모든 도구를 다 챙겨!“라고 지시하는 것과 같아서, 숨겨진 도구가 런타임에서 필요해질 때도 문제없이 사용할 수 있게 해준다.
---

# 참고 링크

- [https://github.com/tuist/tuist/issues/6740](https://github.com/tuist/tuist/issues/6740)